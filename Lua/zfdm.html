<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>争分夺秒 | 潇淼文档</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.ico">
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?bcbe8dcd550616b188183a023ba3e682";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
    <meta name="description" content="MiniDoc">
    <meta name="robots" content="all">
    <meta name="author" content="msk11@qq.com">
    <meta name="copyright" content="Hcat">
    <meta name="revisit-after" content="7 days">
    <meta name="keywords" content="潇淼文档,潇淼,迷你世界,文档,迷你,mini,doc,世界,MiniWorld,脚本,教程">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.84203ac8.css" as="style"><link rel="preload" href="/assets/js/app.ef735673.js" as="script"><link rel="preload" href="/assets/js/2.b51029ec.js" as="script"><link rel="preload" href="/assets/js/46.b5d5ec9d.js" as="script"><link rel="prefetch" href="/assets/js/10.08f53c0a.js"><link rel="prefetch" href="/assets/js/11.852fe533.js"><link rel="prefetch" href="/assets/js/12.387441d1.js"><link rel="prefetch" href="/assets/js/13.026b2d2d.js"><link rel="prefetch" href="/assets/js/14.234e0442.js"><link rel="prefetch" href="/assets/js/15.05982601.js"><link rel="prefetch" href="/assets/js/16.6ddb7b54.js"><link rel="prefetch" href="/assets/js/17.c8e27348.js"><link rel="prefetch" href="/assets/js/18.bea8b7b8.js"><link rel="prefetch" href="/assets/js/19.8032166c.js"><link rel="prefetch" href="/assets/js/20.e8575946.js"><link rel="prefetch" href="/assets/js/21.78fb8e90.js"><link rel="prefetch" href="/assets/js/22.1d33cf5f.js"><link rel="prefetch" href="/assets/js/23.7b04bc71.js"><link rel="prefetch" href="/assets/js/24.e2b60efb.js"><link rel="prefetch" href="/assets/js/25.5d5a4485.js"><link rel="prefetch" href="/assets/js/26.8173389b.js"><link rel="prefetch" href="/assets/js/27.b71f4454.js"><link rel="prefetch" href="/assets/js/28.e1ca4b97.js"><link rel="prefetch" href="/assets/js/29.929be50a.js"><link rel="prefetch" href="/assets/js/3.df829fda.js"><link rel="prefetch" href="/assets/js/30.7e96e268.js"><link rel="prefetch" href="/assets/js/31.c0e69237.js"><link rel="prefetch" href="/assets/js/32.7a31538c.js"><link rel="prefetch" href="/assets/js/33.9f9fcbee.js"><link rel="prefetch" href="/assets/js/34.1a23bcc8.js"><link rel="prefetch" href="/assets/js/35.d646c169.js"><link rel="prefetch" href="/assets/js/36.23fde348.js"><link rel="prefetch" href="/assets/js/37.72568f5d.js"><link rel="prefetch" href="/assets/js/38.c16df410.js"><link rel="prefetch" href="/assets/js/39.beaf8a5b.js"><link rel="prefetch" href="/assets/js/4.af196e2c.js"><link rel="prefetch" href="/assets/js/40.a6c3be0f.js"><link rel="prefetch" href="/assets/js/41.55dcf4c0.js"><link rel="prefetch" href="/assets/js/42.194c1906.js"><link rel="prefetch" href="/assets/js/43.23218e8b.js"><link rel="prefetch" href="/assets/js/44.d7674f0c.js"><link rel="prefetch" href="/assets/js/45.98b149c7.js"><link rel="prefetch" href="/assets/js/47.b3a38716.js"><link rel="prefetch" href="/assets/js/48.ea0a7e3f.js"><link rel="prefetch" href="/assets/js/5.18feaa6c.js"><link rel="prefetch" href="/assets/js/6.7e6925c7.js"><link rel="prefetch" href="/assets/js/7.1b7a5d04.js"><link rel="prefetch" href="/assets/js/8.f363ac78.js"><link rel="prefetch" href="/assets/js/9.61f6ba62.js">
    <link rel="stylesheet" href="/assets/css/0.styles.84203ac8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">潇淼文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/Hcat.html" class="nav-link">
  联系我们
</a></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="http://xor.hcat.work/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  XOR加密
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/Hcat.html" class="nav-link">
  联系我们
</a></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="http://xor.hcat.work/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  XOR加密
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基本要素</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Lua脚本</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Lua/2048.html" class="sidebar-link">Game 2048</a></li><li><a href="/Lua/void.html" class="sidebar-link">不那么仁慈的虚空</a></li><li><a href="/Lua/zfdm.html" aria-current="page" class="active sidebar-link">争分夺秒</a></li><li><a href="/Lua/tankx.html" class="sidebar-link">坦克对战</a></li><li><a href="/Lua/Stone_code.html" class="sidebar-link">Stone Code</a></li><li><a href="/Lua/Gomoku.html" class="sidebar-link">五子棋（Gomoku）</a></li><li><a href="/Lua/fight_for_gold_bricks.html" class="sidebar-link">夺金之战（Fight for Gold Bricks）</a></li><li><a href="/Lua/example.html" class="sidebar-link">示例整合Examples collection</a></li><li><a href="/Lua/Mini_Fast_Food_Restaurant.html" class="sidebar-link">迷你快餐店（Mini Fast Food Restaurant）</a></li><li><a href="/Lua/color_fight.html" class="sidebar-link">好色之途（Color Fight）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>拓展元素</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>商业化[圈钱]</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>游戏全局数据表</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="争分夺秒"><a href="#争分夺秒" class="header-anchor">#</a> 争分夺秒</h1> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 地图常量数据</span>
<span class="token keyword">local</span> Cfg <span class="token operator">=</span> <span class="token punctuation">{</span>
	map_size <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>  <span class="token comment">--地图大小</span>
	map_high <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>   <span class="token comment">--城墙高度</span>
	pool_width <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">--水池竖宽</span>
	pool_lenth <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span><span class="token comment">--水池横长</span>
	max_score <span class="token operator">=</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token comment">--游戏分数</span>
<span class="token punctuation">}</span>

<span class="token comment">-- ItemID数据</span>
<span class="token keyword">local</span> Items <span class="token operator">=</span> <span class="token punctuation">{</span>
	waterId <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>   <span class="token comment">--水方块ID</span>
	treatId <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span>   <span class="token comment">--加血方块ID</span>
	floorId <span class="token operator">=</span> <span class="token number">104</span><span class="token punctuation">,</span> <span class="token comment">--地板方块ID</span>

	fishCnt <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>      <span class="token comment">--灯笼鱼</span>
	fishIdx <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">,</span>   <span class="token comment">--灯笼鱼ID</span>
	starCnt <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span>     <span class="token comment">--闪星数量</span>
	starIdx <span class="token operator">=</span> <span class="token number">997</span><span class="token punctuation">,</span>    <span class="token comment">--闪星方块</span>
	rewardCnt <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span>   <span class="token comment">--肘子数量</span>
	rewardIdx <span class="token operator">=</span> <span class="token number">12526</span><span class="token punctuation">,</span><span class="token comment">--大肘子ID</span>

	redFlagId <span class="token operator">=</span> <span class="token number">919</span><span class="token punctuation">,</span>  <span class="token comment">--红旗ID</span>
	blueFlagId <span class="token operator">=</span> <span class="token number">920</span><span class="token punctuation">,</span> <span class="token comment">--蓝旗ID</span>

	mobsCnt <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">--怪物数量/ID组</span>
	mobsIdx <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">3132</span><span class="token punctuation">,</span> <span class="token number">3132</span><span class="token punctuation">,</span> <span class="token number">3407</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

	<span class="token comment">-- 测试方块trigger事件 --</span>
	trigger_tx <span class="token operator">=</span> <span class="token number">11311</span><span class="token punctuation">,</span> <span class="token comment">--动物肥料</span>
	trigger_x1 <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">,</span>   <span class="token comment">--桃花树苗</span>
	trigger_ty <span class="token operator">=</span> <span class="token number">11055</span><span class="token punctuation">,</span> <span class="token comment">--点火器</span>
	trigger_y1 <span class="token operator">=</span> <span class="token number">881</span><span class="token punctuation">,</span>   <span class="token comment">--喷花烟花</span>
	trigger_y2 <span class="token operator">=</span> <span class="token number">931</span><span class="token punctuation">,</span>   <span class="token comment">--蜡烛台</span>
<span class="token punctuation">}</span>
<span class="token comment">-- 系统相关数据</span>
<span class="token keyword">local</span> Sys <span class="token operator">=</span> <span class="token punctuation">{</span>
	chatType <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">--公告类型 1:系统公告</span>
<span class="token punctuation">}</span>
<span class="token keyword">local</span> Teams <span class="token operator">=</span> <span class="token punctuation">{</span>red<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> blue<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span> <span class="token comment">--游戏队伍</span>
<span class="token keyword">local</span> Battle <span class="token operator">=</span> <span class="token punctuation">{</span>win<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> lose<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> draw<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">}</span> <span class="token comment">--战斗结果</span>
<span class="token keyword">local</span> LiveType <span class="token operator">=</span> <span class="token punctuation">{</span>all<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>dead<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> alive<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">--玩家状态</span>

<span class="token comment">-- 位置区域数据</span>
<span class="token keyword">local</span> Pos <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">--初始数据</span>
	ix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> iy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> iz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">--默认出生点</span>
	cx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> cr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">--雾圈原点/半径</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 游戏数据</span>
<span class="token keyword">local</span> Data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">--随游戏逻辑变更</span>
	tickCount <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token comment">-- tick计数</span>
    newTicker <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">,</span>	   <span class="token comment">-- 刷新时长</span>
    glEffectId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token comment">-- 雾圈ID</span>
    miniMarkId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>   <span class="token comment">-- 小地图标记</span>
    markRadius <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span>  <span class="token comment">-- 地图标记半径</span>
    isTimeout <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token comment">-- 是否超时</span>
	isGameEnd <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token comment">-- 是否已结束</span>
	isRuleInit <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span><span class="token comment">-- 游戏是否初始化</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 游戏怪物数据</span>
<span class="token keyword">local</span> Mobs <span class="token operator">=</span> <span class="token punctuation">{</span>
	objIds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">--怪物objId</span>
	gensCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">--攻击手数量</span>
	deadCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">--已死量数量</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 其他测试数据</span>
<span class="token keyword">local</span> posBlocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">--正收益+5分</span>
<span class="token keyword">local</span> negBlocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">--负收益/变鸡或变羊</span>
<span class="token keyword">local</span> rewBlocks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">816</span><span class="token punctuation">,</span> <span class="token number">739</span><span class="token punctuation">,</span> <span class="token number">1035</span><span class="token punctuation">,</span> <span class="token number">1057</span><span class="token punctuation">,</span> <span class="token number">816</span><span class="token punctuation">}</span>
<span class="token keyword">local</span> weaponIdx <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">12005</span><span class="token punctuation">}</span><span class="token comment">--, 15000, 15501} --武器组ID</span>
<span class="token keyword">local</span> itemBuffs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">12499</span><span class="token punctuation">,</span> <span class="token number">12542</span><span class="token punctuation">,</span> <span class="token number">12559</span><span class="token punctuation">}</span><span class="token comment">--测试Buff接口</span>
<span class="token keyword">local</span> itemTools <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">11311</span><span class="token punctuation">,</span> <span class="token number">11500</span><span class="token punctuation">,</span> <span class="token number">11055</span><span class="token punctuation">}</span><span class="token comment">--测试方块事件</span>
<span class="token keyword">local</span> itemLamps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">881</span><span class="token punctuation">,</span> <span class="token number">881</span><span class="token punctuation">,</span> <span class="token number">931</span><span class="token punctuation">}</span> <span class="token comment">--测试方块触发事件</span>

<span class="token keyword">local</span> cgroupId1 <span class="token operator">=</span> <span class="token keyword">nil</span> <span class="token comment">--生物组1/狼</span>
<span class="token keyword">local</span> cgroupId2 <span class="token operator">=</span> <span class="token keyword">nil</span> <span class="token comment">--生物组2/鱼</span>

<span class="token comment">--[[
游戏玩法：寻找武器杀死野怪,并获取宝物积累分数,分高者胜出.
		 分数累计情况：1、获取宝物+1 杀死怪物+3 杀死对手+5 开启宝箱+7
		 游戏结束情况：1、游戏超时 2、怪物全被干掉 3、分数达到25
		 游戏其他效果：进入雾圈后debuff自动清除/踩上最上层草地后每秒加血
--]]</span>

<span class="token keyword">function</span> <span class="token function">ListenEvents_MiniDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">--游戏事件---</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Game.Start]=]</span><span class="token punctuation">,</span> Game_StartGame<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Game.Run]=]</span><span class="token punctuation">,</span> Game_Update<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Game.End]=]</span><span class="token punctuation">,</span> Game_GameEnd<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Game.TimeOver]=]</span><span class="token punctuation">,</span> Game_TimeOver<span class="token punctuation">)</span>

	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Actor.Die]=]</span><span class="token punctuation">,</span> Actor_Die<span class="token punctuation">)</span>
	<span class="token comment">--玩家事件---</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Player.Init]=]</span><span class="token punctuation">,</span> Player_Inited<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Player.Die]=]</span><span class="token punctuation">,</span> Player_Dead<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Player.Revive]=]</span><span class="token punctuation">,</span> Player_Revive<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Player.AddItem]=]</span><span class="token punctuation">,</span> Player_AddItem<span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent</span><span class="token punctuation">(</span><span class="token string">[=[Player.JoinTeam]=]</span><span class="token punctuation">,</span> Player_JoinTeam<span class="token punctuation">)</span>

	<span class="token comment">--方块事件---</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent_Block</span><span class="token punctuation">(</span><span class="token string">[=[Block.Add]=]</span><span class="token punctuation">,</span> Block_Added<span class="token punctuation">,</span> <span class="token punctuation">{</span>Items<span class="token punctuation">.</span>redFlagId<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>blueFlagId<span class="token punctuation">}</span><span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent_Block</span><span class="token punctuation">(</span><span class="token string">[=[Block.Remove]=]</span><span class="token punctuation">,</span> Block_Removed<span class="token punctuation">,</span> <span class="token punctuation">{</span>Items<span class="token punctuation">.</span>redFlagId<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>blueFlagId<span class="token punctuation">}</span><span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent_Block</span><span class="token punctuation">(</span><span class="token string">[=[Block.PlaceBy]=]</span><span class="token punctuation">,</span> Block_Placed<span class="token punctuation">,</span> <span class="token punctuation">{</span>rewBlocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent_Block</span><span class="token punctuation">(</span><span class="token string">[=[Block.DestroyBy]=]</span><span class="token punctuation">,</span> Block_Destroy<span class="token punctuation">,</span> rewBlocks<span class="token punctuation">)</span>

	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent_Block</span><span class="token punctuation">(</span><span class="token string">[=[Block.Trigger]=]</span><span class="token punctuation">,</span> Block_TriggerBy<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">881</span><span class="token punctuation">,</span> <span class="token number">931</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">--ScriptSupportEvent:registerEvent_Block([=[Block.ActorCollide]=], Block_WalkedBy, rewBlocks)</span>
	<span class="token comment">--ScriptSupportEvent:registerEvent_Block([=[Block.ActorWalking]=], Block_CollidedBy, {Items.treatId})</span>
	ScriptSupportEvent<span class="token punctuation">:</span><span class="token function">registerEvent_Block</span><span class="token punctuation">(</span><span class="token string">[=[Block.Fertilize]=]</span><span class="token punctuation">,</span> Block_FertilizedBy<span class="token punctuation">,</span> <span class="token punctuation">{</span>Items<span class="token punctuation">.</span>trigger_x1<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">-------------------------------自定义方法-------------------------------</span>
<span class="token keyword">function</span> <span class="token function">InitGameRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	Data<span class="token punctuation">.</span>isRuleInit <span class="token operator">=</span> <span class="token keyword">true</span>
	GameRule<span class="token punctuation">.</span>EndTime <span class="token operator">=</span> <span class="token number">9</span>  <span class="token comment">--游戏时长</span>
	GameRule<span class="token punctuation">.</span>CurTime <span class="token operator">=</span> <span class="token number">17.9</span>  <span class="token comment">--当前时间</span>
	GameRule<span class="token punctuation">.</span>LifeNum <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment">--玩家生命</span>
	GameRule<span class="token punctuation">.</span>TeamNum <span class="token operator">=</span> <span class="token number">2</span>
	GameRule<span class="token punctuation">.</span>MaxPlayers <span class="token operator">=</span> <span class="token number">2</span>

	GameRule<span class="token punctuation">.</span>CameraDir <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">--1:正视角</span>
	GameRule<span class="token punctuation">.</span>StartMode <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--0:房主开启</span>
	GameRule<span class="token punctuation">.</span>StartPlayers <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token comment">-- GameRule.ScoreKillMob = 3 --击杀特定怪物+3分</span>
	GameRule<span class="token punctuation">.</span>ScoreKillPlayer <span class="token operator">=</span> <span class="token number">5</span> <span class="token comment">--击杀玩家+5分</span>
	GameRule<span class="token punctuation">.</span>PlayerDieDrops <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">--死亡掉落 1:true</span>
	GameRule<span class="token punctuation">.</span>DisplayScore <span class="token operator">=</span> <span class="token number">1</span>    <span class="token comment">--显示比分 1:true</span>
<span class="token keyword">end</span>
<span class="token keyword">function</span> <span class="token function">InitCenterPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">-- 获取出生点,并以此设置地图中心</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z <span class="token operator">=</span> Spawnport<span class="token punctuation">:</span><span class="token function">getSpawnPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	Pos<span class="token punctuation">.</span>ix <span class="token operator">=</span> x
	Pos<span class="token punctuation">.</span>iy <span class="token operator">=</span> y
	Pos<span class="token punctuation">.</span>iz <span class="token operator">=</span> z
	<span class="token comment">--地平面的y轴坐标为7</span>
	<span class="token keyword">if</span> y<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span> Pos<span class="token punctuation">.</span>iy <span class="token operator">=</span> <span class="token number">6</span> <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> <span class="token function">InitGamePlayer</span><span class="token punctuation">(</span>isTestMode<span class="token punctuation">)</span>
	<span class="token comment">--获取本地玩家信息</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> playerId <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getMainPlayerUin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Backpack<span class="token punctuation">:</span><span class="token function">clearAllPack</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> teamId <span class="token operator">=</span> isClient <span class="token keyword">and</span> Teams<span class="token punctuation">.</span>blue <span class="token keyword">or</span> Teams<span class="token punctuation">.</span>red
	<span class="token keyword">local</span> result <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">setTeam</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> teamId<span class="token punctuation">)</span> <span class="token comment">--主机默认为红队</span>
	<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">ResetPosition</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> teamId<span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token function">GainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span> <span class="token comment">--默认给玩家的道具</span>

	<span class="token keyword">if</span> isTestMode <span class="token keyword">then</span> <span class="token comment">--枪械测试</span>
		<span class="token comment">-- local itemId, itemCnt = 12247, 1 --彩蛋枪</span>
		<span class="token comment">-- Player:gainItems(playerId, itemId, itemCnt, 1)</span>
		<span class="token comment">-- local itemId, itemCnt = 12249, 1*64--子弹</span>
		<span class="token comment">-- Player:gainItems(playerId, itemId, itemCnt, 1)</span>
		<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">15004</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">--狙击枪</span>
		Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">15003</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">64</span><span class="token comment">--子弹</span>
		Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token comment">--设置饱食度小于90,防止自动加血</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> foodLv <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getFoodLevel</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> foodLv<span class="token operator">&gt;</span><span class="token number">90</span> <span class="token keyword">then</span>
		<span class="token comment">--Player:setFoodLevel(playerId, 70)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">function</span> <span class="token function">InitGameMap</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> isTestMode<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">--设置游戏围栏</span>
	<span class="token keyword">local</span> map_high <span class="token operator">=</span> Cfg<span class="token punctuation">.</span>map_high
	<span class="token keyword">if</span> isTestMode <span class="token keyword">then</span> map_high <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">end</span>
	<span class="token keyword">for</span> yPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span>map_high <span class="token keyword">do</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>length<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>length <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>length<span class="token punctuation">,</span> blockId<span class="token punctuation">)</span><span class="token punctuation">;</span>
			Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>length<span class="token punctuation">,</span> blockId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">end</span>

		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>length<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>length <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>length<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> blockId<span class="token punctuation">)</span><span class="token punctuation">;</span>
			Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>length<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> blockId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">local</span> yPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span>map_high <span class="token comment">--给最上层围栏设置缺口</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>length<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>length<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">do</span>
		Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>length<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
		Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>length<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
	<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>length<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>length<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">do</span>
		Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>length<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
		Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>length<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token keyword">if</span> <span class="token keyword">not</span> isTestMode <span class="token keyword">then</span> <span class="token comment">--测试模式不创建地板</span>
		<span class="token keyword">if</span> Items<span class="token punctuation">.</span>floorId <span class="token operator">~=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token comment">--设置地板方块</span>
			<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>length<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>length <span class="token keyword">do</span>
				<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>length<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>length <span class="token keyword">do</span>
					Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>floorId<span class="token punctuation">)</span><span class="token comment">--bId为1时无法生成怪物</span>
				<span class="token keyword">end</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token function">InitSmallPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">--设置中央水池</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> isTestMode <span class="token keyword">then</span> <span class="token comment">--测试时选择创建</span>
		<span class="token function">InitHpTreeAndTotem</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">--治疗树</span>
		<span class="token function">InitTeamCity</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">--红队复活点</span>
		<span class="token function">InitTeamCity</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">--蓝队复活点</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--获取某区域内可放置道具的点</span>
<span class="token keyword">function</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">,</span>yp<span class="token punctuation">,</span>isUp<span class="token punctuation">)</span>
	x1 <span class="token operator">=</span> x1 <span class="token keyword">or</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">+</span><span class="token number">1</span>
	x2 <span class="token operator">=</span> x2 <span class="token keyword">or</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">1</span>
	z1 <span class="token operator">=</span> z1 <span class="token keyword">or</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">+</span><span class="token number">1</span>
	z2 <span class="token operator">=</span> z2 <span class="token keyword">or</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">1</span>
	yp <span class="token operator">=</span> yp <span class="token keyword">or</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span>  <span class="token comment">--地面/水里</span>
	isUp <span class="token operator">=</span> isUp<span class="token operator">==</span><span class="token keyword">nil</span> <span class="token keyword">and</span> <span class="token keyword">true</span> <span class="token keyword">or</span> isUp<span class="token comment">--默认true</span>

	<span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">local</span> xPos<span class="token punctuation">,</span> zPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> blkId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token keyword">while</span> <span class="token keyword">true</span> <span class="token keyword">do</span>
		count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
		xPos <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> x2<span class="token punctuation">)</span>
		zPos <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>z1<span class="token punctuation">,</span> z2<span class="token punctuation">)</span>

		ret<span class="token punctuation">,</span> blkId <span class="token operator">=</span> Block<span class="token punctuation">:</span><span class="token function">getBlockID</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yp<span class="token punctuation">,</span> zPos<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> blkId<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span>
			<span class="token keyword">if</span> isUp <span class="token keyword">then</span> <span class="token comment">--地表方块需同时判断下是否有支撑</span>
				<span class="token keyword">local</span> ret2<span class="token punctuation">,</span> blkId2 <span class="token operator">=</span> Block<span class="token punctuation">:</span><span class="token function">getBlockID</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yp<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">)</span>
				<span class="token keyword">if</span> ret2<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> blkId2<span class="token operator">~=</span>Items<span class="token punctuation">.</span>waterId <span class="token keyword">then</span> <span class="token keyword">break</span> <span class="token keyword">end</span>
			<span class="token keyword">else</span> <span class="token comment">--只判断当前是否有方块占着</span>
				<span class="token keyword">if</span> xPos<span class="token operator">~=</span><span class="token number">0</span> <span class="token keyword">and</span> zPos<span class="token operator">~=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">break</span> <span class="token keyword">end</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
		<span class="token keyword">if</span> <span class="token keyword">not</span> isUp <span class="token keyword">and</span> blkId<span class="token operator">==</span>Items<span class="token punctuation">.</span>waterId <span class="token keyword">then</span> <span class="token keyword">break</span> <span class="token keyword">end</span> <span class="token comment">--是否在水里</span>

		<span class="token comment">--防止参数有误导致死循环</span>
		<span class="token keyword">if</span> count<span class="token operator">&gt;</span><span class="token number">99</span> <span class="token keyword">then</span>
			<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Position Error x===&gt;&gt;&gt;&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token keyword">nil</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
	<span class="token keyword">return</span> xPos<span class="token punctuation">,</span> zPos
<span class="token keyword">end</span>

<span class="token keyword">function</span> <span class="token function">InitTeamCity</span><span class="token punctuation">(</span>teamId<span class="token punctuation">)</span>
	<span class="token comment">--获取起始出生点</span>
	<span class="token keyword">local</span> xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz

	<span class="token keyword">if</span> teamId<span class="token operator">==</span>Teams<span class="token punctuation">.</span>red <span class="token keyword">then</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
	<span class="token keyword">if</span> teamId<span class="token operator">==</span>Teams<span class="token punctuation">.</span>blue <span class="token keyword">then</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> fixDist <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--小门朝向</span>
	<span class="token keyword">local</span> flagFix <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">local</span> homeIdx<span class="token punctuation">,</span> reveIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token keyword">if</span> teamId<span class="token operator">==</span>Teams<span class="token punctuation">.</span>red <span class="token keyword">then</span>
		fixDist <span class="token operator">=</span> <span class="token number">2</span>
		flagFix <span class="token operator">=</span> <span class="token number">1</span>
		homeIdx<span class="token punctuation">,</span> reveIdx <span class="token operator">=</span> <span class="token number">919</span><span class="token punctuation">,</span> <span class="token number">991</span>
	<span class="token keyword">elseif</span> teamId<span class="token operator">==</span>Teams<span class="token punctuation">.</span>blue <span class="token keyword">then</span>
		fixDist <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span>
		flagFix <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		homeIdx<span class="token punctuation">,</span> reveIdx <span class="token operator">=</span> <span class="token number">920</span><span class="token punctuation">,</span> <span class="token number">992</span>
	<span class="token keyword">end</span>
	<span class="token keyword">if</span> homeIdx<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">or</span> reveIdx<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> reveIdx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">-- 复活点</span>
	Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>homeIdx<span class="token punctuation">,</span> xPos<span class="token operator">+</span>fixDist<span class="token punctuation">,</span> yPos<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> zPos<span class="token operator">+</span>flagFix<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">--队旗点</span>

	<span class="token comment">--设置战队保护区</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> <span class="token number">101</span>
	<span class="token keyword">for</span> yIdx <span class="token operator">=</span> yPos<span class="token punctuation">,</span> yPos<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> xIdx <span class="token operator">=</span> xPos<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> xPos<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">do</span> <span class="token comment">--外边缘1</span>
			<span class="token keyword">for</span> zIdx <span class="token operator">=</span> zPos<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> zPos<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
				Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>blockId<span class="token punctuation">,</span> xIdx<span class="token punctuation">,</span> yIdx<span class="token punctuation">,</span> zIdx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>

		<span class="token keyword">for</span> zIdx <span class="token operator">=</span> zPos<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> zPos<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">do</span> <span class="token comment">--外边缘2</span>
			<span class="token keyword">for</span> xIdx <span class="token operator">=</span> xPos<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> xPos<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
				Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>blockId<span class="token punctuation">,</span> xIdx<span class="token punctuation">,</span> yIdx<span class="token punctuation">,</span> zIdx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">local</span> doorId <span class="token operator">=</span> <span class="token number">857</span> <span class="token comment">--开个小门</span>
	Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token operator">+</span>fixDist<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token operator">+</span>fixDist<span class="token punctuation">,</span> yPos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token operator">+</span>fixDist<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token operator">-</span>flagFix<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token operator">+</span>fixDist<span class="token punctuation">,</span> yPos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token operator">-</span>flagFix<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>

	Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>doorId<span class="token punctuation">,</span> xPos<span class="token operator">+</span>fixDist<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token operator">-</span>flagFix<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token comment">--]]</span>

	<span class="token comment">-- if teamId==Teams.red then --工具箱/红队</span>
	<span class="token comment">-- 	Block:placeBlock(881, xPos+3, yPos, zPos+1)</span>
	<span class="token comment">-- else --工具箱/蓝队</span>
	<span class="token comment">-- 	Block:placeBlock(881, xPos-3, yPos, zPos-1)</span>
	<span class="token comment">-- end</span>
<span class="token keyword">end</span>

<span class="token comment">--设置治疗树/图腾</span>
<span class="token keyword">function</span> <span class="token function">InitHpTreeAndTotem</span><span class="token punctuation">(</span>cx<span class="token punctuation">,</span> cz<span class="token punctuation">)</span>
	cx <span class="token operator">=</span> cx <span class="token keyword">or</span> <span class="token number">0</span>
	cz <span class="token operator">=</span> cz <span class="token keyword">or</span> <span class="token number">0</span>

	<span class="token comment">--四种怪物对应四种坦克类型</span>
	<span class="token keyword">local</span> totemIds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">745</span><span class="token punctuation">,</span> <span class="token number">901</span><span class="token punctuation">,</span> <span class="token number">903</span><span class="token punctuation">,</span> <span class="token number">908</span><span class="token punctuation">}</span>
	<span class="token keyword">local</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> z1 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">+</span><span class="token number">5</span>

	<span class="token keyword">for</span> idx<span class="token punctuation">,</span> valId <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>totemIds<span class="token punctuation">)</span> <span class="token keyword">do</span>
		<span class="token keyword">if</span> math<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span>
			x1 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span><span class="token number">3</span>
			z1 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">5</span>
		<span class="token keyword">end</span>
	 	Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>valId<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> z1<span class="token punctuation">)</span>
	 	x1 <span class="token operator">=</span> x1 <span class="token operator">+</span> <span class="token number">6</span>
	<span class="token keyword">end</span>

	<span class="token comment">--设置治疗树/草地</span>
	<span class="token keyword">local</span> floorId <span class="token operator">=</span> <span class="token number">100</span><span class="token comment">--草地</span>
	<span class="token keyword">local</span> xPos1<span class="token punctuation">,</span> xPos2<span class="token punctuation">,</span> yPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span>
	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">do</span>
		yPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iy <span class="token operator">+</span> idx
		xPos1 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">-</span>Cfg<span class="token punctuation">.</span>pool_width<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">+</span> idx
		xPos2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">+</span>Cfg<span class="token punctuation">.</span>pool_width<span class="token operator">+</span><span class="token number">2</span> <span class="token operator">-</span> idx
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>floorId<span class="token punctuation">,</span> xPos1<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">)</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>floorId<span class="token punctuation">,</span> xPos2<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> xPos1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> xPos2<span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">do</span><span class="token comment">--上层草地</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>floorId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> xPos1<span class="token punctuation">,</span> xPos2 <span class="token keyword">do</span><span class="token comment">--下层草地</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> yPos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">local</span> ret1 <span class="token operator">=</span> Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos1<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> yPos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> ret2 <span class="token operator">=</span> Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> yPos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">)</span>
	<span class="token comment">--生成树苗/测试施肥事件/此处placeBlock会失败,因树苗无法放置在草块上</span>
	<span class="token keyword">local</span> ret1 <span class="token operator">=</span> Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>Items<span class="token punctuation">.</span>trigger_x1<span class="token punctuation">,</span> xPos1<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> ret2 <span class="token operator">=</span> Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>Items<span class="token punctuation">.</span>trigger_x1<span class="token punctuation">,</span> xPos2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token comment">--print(&quot;HpTree====================&gt;&gt;&gt;&quot;, ret1, ret2)</span>

	<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span><span class="token comment">--加血区域</span>
			<span class="token comment">--treatPos[#treatPos+1] = {xPos, yPos, zPos}</span>
			Block<span class="token punctuation">:</span><span class="token function">setBlockAll</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>treatId<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">local</span> direct <span class="token operator">=</span> <span class="token number">4</span>
	<span class="token keyword">local</span> tyPos <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--设置树干</span>
	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token keyword">do</span> <span class="token comment">--树高为5</span>
		tyPos <span class="token operator">=</span> yPos <span class="token operator">+</span> idx
		Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token punctuation">,</span> tyPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token comment">--设置树叶/四层树叶</span>
	<span class="token keyword">local</span> leafId <span class="token operator">=</span> <span class="token number">218</span>
	direct <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--第4层树叶</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>leafId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> tyPos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		direct <span class="token operator">=</span> direct <span class="token operator">+</span> <span class="token number">2</span>
	<span class="token keyword">end</span>
	direct <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--第5层树叶</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>leafId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> tyPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		direct <span class="token operator">=</span> direct <span class="token operator">+</span> <span class="token number">2</span>
	<span class="token keyword">end</span>
	direct <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>leafId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> tyPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		direct <span class="token operator">=</span> direct <span class="token operator">+</span> <span class="token number">2</span>
	<span class="token keyword">end</span>
	direct <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--第6层树叶</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>leafId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> tyPos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		direct <span class="token operator">=</span> direct <span class="token operator">+</span> <span class="token number">2</span>
	<span class="token keyword">end</span>
	direct <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">--最上层树叶</span>
	Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>leafId<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>cx<span class="token punctuation">,</span> tyPos<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>cz<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>
	<span class="token comment">--]]</span>

	<span class="token comment">--治疗圈位置/半径</span>
	Pos<span class="token punctuation">.</span>cx<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>cz<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>cr <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix <span class="token operator">+</span> cx<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz <span class="token operator">+</span> cz<span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">*</span><span class="token number">1.2</span>
<span class="token keyword">end</span>

<span class="token comment">--绘制小地图标记</span>
<span class="token keyword">function</span> <span class="token function">drawMiniMark</span><span class="token punctuation">(</span>isNew<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> rx<span class="token punctuation">,</span> mType<span class="token punctuation">)</span>
	<span class="token keyword">if</span> Data<span class="token punctuation">.</span>miniMarkId <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">not</span> mType <span class="token keyword">then</span> <span class="token comment">--清理旧标记</span>
		MapMark<span class="token punctuation">:</span><span class="token function">deleteShape</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">)</span>
	<span class="token keyword">elseif</span> Data<span class="token punctuation">.</span>miniMarkId<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">or</span> isNew <span class="token keyword">then</span> <span class="token comment">--重新绘制标记</span>
		<span class="token keyword">local</span> ret <span class="token operator">=</span> ErrorCode<span class="token punctuation">.</span>FAILED

		<span class="token keyword">local</span> markType <span class="token operator">=</span> MAPMARK_TYPE<span class="token punctuation">.</span>MMARK_CIRCLE
		<span class="token keyword">if</span> mType<span class="token operator">==</span><span class="token number">1</span> <span class="token keyword">then</span> markType <span class="token operator">=</span> MAPMARK_TYPE<span class="token punctuation">.</span>MMARK_LINE <span class="token keyword">end</span>
		<span class="token keyword">if</span> mType<span class="token operator">==</span><span class="token number">2</span> <span class="token keyword">then</span> markType <span class="token operator">=</span> MAPMARK_TYPE<span class="token punctuation">.</span>MMARK_RECTANGLE <span class="token keyword">end</span>

		ret<span class="token punctuation">,</span> Data<span class="token punctuation">.</span>miniMarkId <span class="token operator">=</span> MapMark<span class="token punctuation">:</span><span class="token function">newShape</span><span class="token punctuation">(</span>markType<span class="token punctuation">,</span><span class="token keyword">false</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret<span class="token operator">~=</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Data<span class="token punctuation">.</span>miniMarkId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">if</span> Data<span class="token punctuation">.</span>miniMarkId <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">not</span> isNew <span class="token keyword">then</span>
		<span class="token keyword">if</span> mType <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">then</span><span class="token comment">--线形标记</span>
			MapMark<span class="token punctuation">:</span><span class="token function">setShapeColor</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			MapMark<span class="token punctuation">:</span><span class="token function">updateLine</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> z1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> z2<span class="token punctuation">)</span>
		<span class="token keyword">elseif</span> mType <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">then</span><span class="token comment">--矩形标记</span>
			MapMark<span class="token punctuation">:</span><span class="token function">setShapeColor</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			MapMark<span class="token punctuation">:</span><span class="token function">updateRectangle</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> z1<span class="token punctuation">,</span> x2<span class="token operator">-</span>x1<span class="token punctuation">,</span> z2<span class="token operator">-</span>z1<span class="token punctuation">)</span>
		<span class="token keyword">else</span> <span class="token comment">--圆形标记</span>
			MapMark<span class="token punctuation">:</span><span class="token function">setShapeColor</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			MapMark<span class="token punctuation">:</span><span class="token function">updateCircle</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> z1<span class="token punctuation">,</span> rx<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		MapMark<span class="token punctuation">:</span><span class="token function">showShape</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--地图中生成水池</span>
<span class="token keyword">function</span> <span class="token function">InitSmallPool</span><span class="token punctuation">(</span>pWid<span class="token punctuation">,</span> pLen<span class="token punctuation">)</span>
	pWid <span class="token operator">=</span> pWid <span class="token keyword">and</span> pWid <span class="token keyword">or</span> Cfg<span class="token punctuation">.</span>pool_width
	pLen <span class="token operator">=</span> pLen <span class="token keyword">and</span> pLen <span class="token keyword">or</span> Cfg<span class="token punctuation">.</span>pool_lenth

	<span class="token keyword">local</span> xwid<span class="token punctuation">,</span> zwid <span class="token operator">=</span> pWid<span class="token punctuation">,</span> pLen

	<span class="token keyword">for</span> yPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy <span class="token keyword">do</span><span class="token comment">--挖坑</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span><span class="token punctuation">(</span>xwid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span><span class="token punctuation">(</span>xwid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
			<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span><span class="token punctuation">(</span>zwid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span><span class="token punctuation">(</span>zwid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
				Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>xwid<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>xwid <span class="token keyword">do</span><span class="token comment">--内边缘</span>
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>zwid<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>zwid <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">destroyBlock</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">for</span> yPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy <span class="token keyword">do</span><span class="token comment">--生成水池</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>xwid<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>xwid <span class="token keyword">do</span>
			<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>zwid<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>zwid <span class="token keyword">do</span>
				Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token comment">-- 外边缘1</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> <span class="token number">104</span><span class="token comment">--方块Id</span>
	<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>zwid<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>zwid<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>zwid<span class="token operator">+</span><span class="token number">4</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>xwid<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>xwid<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>blockId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
	<span class="token comment">-- 外边缘2</span>
	<span class="token keyword">for</span> xPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>xwid<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>xwid<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>xwid<span class="token operator">+</span><span class="token number">4</span> <span class="token keyword">do</span>
		<span class="token keyword">for</span> zPos <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>zwid<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>zwid<span class="token operator">+</span><span class="token number">2</span> <span class="token keyword">do</span>
			Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>blockId<span class="token punctuation">,</span> xPos<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--在一定区域内初始化道具</span>
<span class="token keyword">function</span> <span class="token function">InitGameItems</span><span class="token punctuation">(</span>bxsize<span class="token punctuation">)</span>
	<span class="token comment">-- 获取起起始出生点</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz

	<span class="token comment">-- 位置区域</span>
	<span class="token keyword">local</span> x1<span class="token punctuation">,</span> x2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>bxsize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>bxsize<span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">local</span> z1<span class="token punctuation">,</span> z2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>bxsize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>bxsize<span class="token operator">-</span><span class="token number">1</span>

	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Items<span class="token punctuation">.</span>rewardCnt <span class="token keyword">do</span> <span class="token comment">--Item大肘子</span>
		<span class="token keyword">local</span> xPos<span class="token punctuation">,</span> zPos <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		World<span class="token punctuation">:</span><span class="token function">spawnItem</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>rewardIdx<span class="token punctuation">)</span>
	<span class="token keyword">end</span>
	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Items<span class="token punctuation">.</span>rewardCnt <span class="token keyword">do</span> <span class="token comment">--Item动物肥料</span>
		<span class="token keyword">local</span> xPos<span class="token punctuation">,</span> zPos <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		World<span class="token punctuation">:</span><span class="token function">spawnItem</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>rewardIdx<span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token comment">-- 设置大宝剑掉落位置</span>
	<span class="token keyword">for</span> idx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>weaponIdx <span class="token keyword">do</span>
		<span class="token comment">-- local xPos1 = math.random(x1, x2)</span>
		<span class="token comment">-- local zPos1 = math.random(z1, z2)</span>
		<span class="token keyword">local</span> xPos1<span class="token punctuation">,</span> zPos1 <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		World<span class="token punctuation">:</span><span class="token function">spawnItem</span><span class="token punctuation">(</span>xPos1<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos1<span class="token punctuation">,</span> weaponIdx<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token comment">-- 设置BuffItem位置</span>
	<span class="token keyword">for</span> idx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>itemBuffs <span class="token keyword">do</span>
		<span class="token comment">-- local xPos1 = math.random(x1, x2)</span>
		<span class="token comment">-- local zPos1 = math.random(z1, z2)</span>
		<span class="token keyword">local</span> xPos1<span class="token punctuation">,</span> zPos1 <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		World<span class="token punctuation">:</span><span class="token function">spawnItem</span><span class="token punctuation">(</span>xPos1<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos1<span class="token punctuation">,</span> itemBuffs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
	<span class="token comment">-- 设置ToolItem位置</span>
	<span class="token keyword">for</span> idx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>itemTools <span class="token keyword">do</span>
		<span class="token keyword">local</span> itemId <span class="token operator">=</span> itemTools<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
		<span class="token keyword">for</span> jdx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token keyword">do</span> <span class="token comment">--数量</span>
			<span class="token keyword">local</span> xPos1<span class="token punctuation">,</span> zPos1 <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
			World<span class="token punctuation">:</span><span class="token function">spawnItem</span><span class="token punctuation">(</span>xPos1<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos1<span class="token punctuation">,</span> itemId<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>rewBlocks <span class="token keyword">do</span> <span class="token comment">--方块碰撞区</span>
		<span class="token keyword">local</span> blockId <span class="token operator">=</span> rewBlocks<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
		<span class="token keyword">local</span> direct <span class="token operator">=</span> idx<span class="token operator">~=</span><span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">3</span> <span class="token keyword">or</span> <span class="token number">4</span>
		<span class="token keyword">local</span> xPos0<span class="token punctuation">,</span> zPos0 <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>blockId<span class="token punctuation">,</span> xPos0<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos0<span class="token punctuation">,</span> direct<span class="token punctuation">)</span>

		<span class="token comment">--设置正负收益方块</span>
		<span class="token keyword">local</span> randx <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> randx<span class="token operator">&lt;=</span><span class="token number">5</span> <span class="token keyword">and</span> <span class="token operator">#</span>posBlocks<span class="token operator">&lt;</span><span class="token number">2</span> <span class="token keyword">or</span> idx<span class="token operator">==</span><span class="token number">1</span> <span class="token keyword">then</span>
			posBlocks<span class="token punctuation">[</span><span class="token operator">#</span>posBlocks<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> blockId
		<span class="token keyword">else</span>
			negBlocks<span class="token punctuation">[</span><span class="token operator">#</span>negBlocks<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> blockId
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>itemLamps <span class="token keyword">do</span> <span class="token comment">--方块触发区</span>
		<span class="token keyword">local</span> xPos0<span class="token punctuation">,</span> zPos0 <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>itemLamps<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> xPos0<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos0<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Items<span class="token punctuation">.</span>starCnt <span class="token keyword">do</span> <span class="token comment">--方块触发区</span>
		<span class="token keyword">local</span> xPos0<span class="token punctuation">,</span> zPos0 <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		Block<span class="token punctuation">:</span><span class="token function">placeBlock</span><span class="token punctuation">(</span>Items<span class="token punctuation">.</span>starIdx<span class="token punctuation">,</span> xPos0<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos0<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--在一定区域内初始化怪物</span>
<span class="token keyword">function</span> <span class="token function">InitGameMobs</span><span class="token punctuation">(</span>bxsize<span class="token punctuation">)</span>
	<span class="token comment">-- 获取起起始出生点</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz

	<span class="token comment">-- 位置区域</span>
	<span class="token keyword">local</span> x1<span class="token punctuation">,</span> x2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>bxsize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>bxsize<span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">local</span> z1<span class="token punctuation">,</span> z2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>bxsize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>bxsize<span class="token operator">-</span><span class="token number">1</span>

	<span class="token comment">-- 生成怪物并设置位置</span>
	<span class="token keyword">for</span> idx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> Items<span class="token punctuation">.</span>mobsCnt <span class="token keyword">do</span>
		<span class="token keyword">local</span> xPos<span class="token punctuation">,</span> zPos <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		<span class="token keyword">local</span> cIdx <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">mod</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token operator">#</span>Items<span class="token punctuation">.</span>mobsIdx<span class="token punctuation">)</span>
		cIdx <span class="token operator">=</span> cIdx<span class="token operator">~=</span><span class="token number">0</span> <span class="token keyword">and</span> cIdx <span class="token keyword">or</span> <span class="token operator">#</span>Items<span class="token punctuation">.</span>mobsIdx
		<span class="token keyword">local</span> curMobId <span class="token operator">=</span> Items<span class="token punctuation">.</span>mobsIdx<span class="token punctuation">[</span>cIdx<span class="token punctuation">]</span>
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> objIds <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">spawnCreature</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> y<span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> curMobId<span class="token punctuation">)</span>

		<span class="token keyword">if</span> objIds <span class="token keyword">and</span> <span class="token function">type</span><span class="token punctuation">(</span>objIds<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">&quot;table&quot;</span> <span class="token keyword">then</span>
			<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>objIds <span class="token keyword">do</span> <span class="token comment">--遍历设置攻击手属性</span>
				<span class="token keyword">local</span> attrType <span class="token operator">=</span> MODATTRIB_TYPE<span class="token punctuation">.</span>MODATTR_MOVE_SPEED
				<span class="token keyword">local</span> ret<span class="token punctuation">,</span> value <span class="token operator">=</span> Creature<span class="token punctuation">:</span><span class="token function">getModAttrib</span><span class="token punctuation">(</span>objIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> attrType<span class="token punctuation">)</span>
				<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'MODATTR_MOVE_SPEED--------------------&gt;&gt;&gt;'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
				<span class="token keyword">local</span> result <span class="token operator">=</span> Creature<span class="token punctuation">:</span><span class="token function">addModAttrib</span><span class="token punctuation">(</span>objIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> attrType<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> result <span class="token operator">==</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'增加怪物移动速度'</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

				Mobs<span class="token punctuation">.</span>objIds<span class="token punctuation">[</span><span class="token operator">#</span>Mobs<span class="token punctuation">.</span>objIds<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> objIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
				<span class="token keyword">if</span> curMobId <span class="token operator">==</span> Items<span class="token punctuation">.</span>mobsIdx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
					Mobs<span class="token punctuation">.</span>gensCnt <span class="token operator">=</span> Mobs<span class="token punctuation">.</span>gensCnt <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">--攻击手</span>
				<span class="token keyword">else</span> <span class="token comment">-- 生物组1-&gt;狼群</span>
					Trigger<span class="token punctuation">.</span>CreatureGroup<span class="token punctuation">:</span><span class="token function">addCreatureToGroup</span><span class="token punctuation">(</span>objIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> cgroupId1<span class="token punctuation">)</span>
				<span class="token keyword">end</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token comment">--设置怪物属性</span>
	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>Mobs<span class="token punctuation">.</span>objIds <span class="token keyword">do</span>
		<span class="token keyword">local</span> mobObjId <span class="token operator">=</span> Mobs<span class="token punctuation">.</span>objIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
		<span class="token keyword">local</span> isMob <span class="token operator">=</span> Actor<span class="token punctuation">:</span><span class="token function">isMob</span><span class="token punctuation">(</span>mobObjId<span class="token punctuation">)</span>
		<span class="token keyword">if</span> isMob<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token comment">--确实是怪物</span>
			<span class="token keyword">local</span> ret<span class="token punctuation">,</span> actorId <span class="token operator">=</span> Creature<span class="token punctuation">:</span><span class="token function">getActorID</span><span class="token punctuation">(</span>mobObjId<span class="token punctuation">)</span>
			<span class="token keyword">if</span> actorId <span class="token operator">==</span> Items<span class="token punctuation">.</span>mobsIdx<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">then</span><span class="token comment">--狼</span>
				Creature<span class="token punctuation">:</span><span class="token function">setPanic</span><span class="token punctuation">(</span>mobObjId<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
				Creature<span class="token punctuation">:</span><span class="token function">setAIActive</span><span class="token punctuation">(</span>mobObjId<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
				<span class="token keyword">local</span> result <span class="token operator">=</span> Creature<span class="token punctuation">:</span><span class="token function">setOxygenNeed</span><span class="token punctuation">(</span>mobObjId<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token keyword">local</span> xwid<span class="token punctuation">,</span> zwid<span class="token punctuation">,</span> count <span class="token operator">=</span> <span class="token number">7</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span>
	<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> count <span class="token keyword">do</span> <span class="token comment">--水池范围生成鱼类</span>
		<span class="token comment">-- local xPos = math.random(Pos.ix-xwid, Pos.ix+xwid)</span>
		<span class="token comment">-- local zPos = math.random(Pos.iz-zwid, Pos.iz+zwid)</span>
		x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>xwid<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>xwid<span class="token punctuation">,</span>Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>zwid<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>zwid
		<span class="token keyword">local</span> xPos<span class="token punctuation">,</span>zPos <span class="token operator">=</span> <span class="token function">getPosition</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iy<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> objIds <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">spawnCreature</span><span class="token punctuation">(</span>xPos<span class="token punctuation">,</span> y<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> zPos<span class="token punctuation">,</span> Items<span class="token punctuation">.</span>fishIdx<span class="token punctuation">)</span>

		<span class="token keyword">if</span> objIds <span class="token keyword">and</span> <span class="token function">type</span><span class="token punctuation">(</span>objIds<span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">&quot;table&quot;</span> <span class="token keyword">then</span>
			<span class="token keyword">for</span> idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>objIds <span class="token keyword">do</span> <span class="token comment">--生物组2-&gt;鱼群</span>
				Trigger<span class="token punctuation">.</span>CreatureGroup<span class="token punctuation">:</span><span class="token function">addCreatureToGroup</span><span class="token punctuation">(</span>objIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> cgroupId2<span class="token punctuation">)</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;GensX===================&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> Mobs<span class="token punctuation">.</span>gensCnt<span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">--计算游戏结果</span>
<span class="token keyword">function</span> <span class="token function">Battle_Ended</span><span class="token punctuation">(</span>teamId<span class="token punctuation">,</span> retType<span class="token punctuation">)</span>
	<span class="token comment">--local isPlayerValid = Player:isMainPlayerValid()#已取消</span>
	<span class="token comment">--if isPlayerValid ~= ErrorCode.OK then return end</span>

	<span class="token keyword">if</span> teamId <span class="token operator">==</span> Teams<span class="token punctuation">.</span>red <span class="token keyword">then</span>
		<span class="token comment">-- 设置红队游戏结果</span>
		Team<span class="token punctuation">:</span><span class="token function">setTeamResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> retType<span class="token punctuation">)</span>
		Team<span class="token punctuation">:</span><span class="token function">setTeamPlayersResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> retType<span class="token punctuation">)</span>
		<span class="token comment">-- 设置蓝队游戏结果</span>
		<span class="token keyword">local</span> blueRet <span class="token operator">=</span> <span class="token punctuation">(</span>retType<span class="token operator">==</span>Battle<span class="token punctuation">.</span>win <span class="token keyword">and</span> Battle<span class="token punctuation">.</span>lose<span class="token punctuation">)</span> <span class="token keyword">or</span> Battle<span class="token punctuation">.</span>win
		Team<span class="token punctuation">:</span><span class="token function">setTeamResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">,</span> blueRet<span class="token punctuation">)</span>
		Team<span class="token punctuation">:</span><span class="token function">setTeamPlayersResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">,</span> blueRet<span class="token punctuation">)</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Battle1 ================&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> teamId<span class="token punctuation">,</span> retType<span class="token punctuation">,</span> blueRet<span class="token punctuation">)</span>
	<span class="token keyword">elseif</span> teamId <span class="token operator">==</span> Teams<span class="token punctuation">.</span>blue <span class="token keyword">then</span>
		<span class="token comment">-- 设置蓝队游戏结果</span>
		Team<span class="token punctuation">:</span><span class="token function">setTeamResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">,</span> retType<span class="token punctuation">)</span>
		Team<span class="token punctuation">:</span><span class="token function">setTeamPlayersResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">,</span> retType<span class="token punctuation">)</span>
		<span class="token comment">-- 设置红队游戏结果</span>
		<span class="token keyword">local</span> redRet <span class="token operator">=</span> <span class="token punctuation">(</span>retType<span class="token operator">==</span>Battle<span class="token punctuation">.</span>win <span class="token keyword">and</span> Battle<span class="token punctuation">.</span>lose<span class="token punctuation">)</span> <span class="token keyword">or</span> Battle<span class="token punctuation">.</span>win
		Team<span class="token punctuation">:</span><span class="token function">setTeamResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> redRet<span class="token punctuation">)</span>
		Team<span class="token punctuation">:</span><span class="token function">setTeamPlayersResults</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> redRet<span class="token punctuation">)</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Battle2 ================&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> teamId<span class="token punctuation">,</span> retType<span class="token punctuation">,</span> redRet<span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token function">ShowGBattleUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--设置战斗总结界面</span>
<span class="token keyword">end</span>

<span class="token comment">--游戏结算界面</span>
<span class="token keyword">function</span> <span class="token function">ShowGBattleUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">-- 设置排行/分数</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> rank <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getGameRanking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> rank <span class="token keyword">or</span> rank<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span> rank <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">end</span>
    <span class="token keyword">local</span> ret<span class="token punctuation">,</span> score <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getGameScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">-- 队伍数量及成员量</span>
    <span class="token keyword">local</span> ret1<span class="token punctuation">,</span> teamNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getNumTeam</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">local</span> ret2<span class="token punctuation">,</span> redNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamPlayers</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">)</span>
    <span class="token keyword">local</span> ret3<span class="token punctuation">,</span> blueNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamPlayers</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">)</span>
  	<span class="token keyword">local</span> totalPlayers <span class="token operator">=</span> <span class="token number">1</span>
  	<span class="token keyword">if</span> ret2<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> ret3<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span>
  		totalPlayers <span class="token operator">=</span> redNum<span class="token operator">+</span>blueNum
  	<span class="token keyword">end</span>

  	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtTitle <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span>rank<span class="token operator">==</span><span class="token number">1</span> <span class="token keyword">and</span> <span class="token number">8028</span> <span class="token keyword">or</span> <span class="token number">8029</span><span class="token punctuation">)</span>
  	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtTRank <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">8032</span><span class="token punctuation">)</span>
  	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtRanker <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">8030</span><span class="token punctuation">)</span>
  	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtDefeat <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">3176</span><span class="token punctuation">)</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'left_title'</span><span class="token punctuation">,</span> txtTRank<span class="token operator">..</span><span class="token function">tostring</span><span class="token punctuation">(</span>rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--第1/1</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'right_title'</span><span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token operator">..</span>totalPlayers<span class="token punctuation">)</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'left_desc'</span><span class="token punctuation">,</span> txtTitle<span class="token punctuation">)</span><span class="token comment">--大吉大利/继续努力</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'left_little_desc'</span><span class="token punctuation">,</span> txtRanker<span class="token operator">..</span><span class="token function">tostring</span><span class="token punctuation">(</span>rank<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--排名</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'right_little_desc'</span><span class="token punctuation">,</span> txtDefeat<span class="token operator">..</span><span class="token function">tostring</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">--得分</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'battle_btn'</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'result_bkg'</span><span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
	UI<span class="token punctuation">:</span><span class="token function">setGBattleUI</span><span class="token punctuation">(</span><span class="token string">'reopen'</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment">--重置玩家位置</span>
<span class="token keyword">function</span> <span class="token function">ResetPosition</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> teamId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> playerId<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token keyword">or</span> teamId<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token keyword">if</span> teamId <span class="token operator">==</span> Teams<span class="token punctuation">.</span>red <span class="token keyword">then</span>      <span class="token comment">--红队出生/复活点</span>
		<span class="token keyword">local</span> ret <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">setPosition</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span>
	<span class="token keyword">elseif</span> teamId <span class="token operator">==</span> Teams<span class="token punctuation">.</span>blue <span class="token keyword">then</span> <span class="token comment">--蓝队出生/复活点</span>
		<span class="token keyword">local</span> ret <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">setPosition</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span><span class="token number">0.5</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--初始玩家道具</span>
<span class="token keyword">function</span> <span class="token function">GainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span>
	<span class="token comment">--给玩家一把短刀做防御,优先快捷栏</span>
	<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">12003</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">--短刀</span>
	<span class="token keyword">local</span> ret <span class="token operator">=</span> Backpack<span class="token punctuation">:</span><span class="token function">enoughSpaceForItem</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">11001</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">--木斧</span>
	<span class="token keyword">local</span> ret <span class="token operator">=</span> Backpack<span class="token punctuation">:</span><span class="token function">enoughSpaceForItem</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">--果木</span>
	<span class="token keyword">local</span> ret <span class="token operator">=</span> Backpack<span class="token punctuation">:</span><span class="token function">enoughSpaceForItem</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">230</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token comment">--南瓜</span>
	<span class="token keyword">local</span> ret <span class="token operator">=</span> Backpack<span class="token punctuation">:</span><span class="token function">enoughSpaceForItem</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">817</span><span class="token punctuation">,</span> <span class="token number">2</span>
	<span class="token keyword">local</span> isDayTx <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">isDaytime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--白天:true 黑夜:false</span>
	<span class="token keyword">local</span> result <span class="token operator">=</span> Backpack<span class="token punctuation">:</span><span class="token function">enoughSpaceForItem</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">)</span>

	<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> <span class="token keyword">not</span> isDayTx <span class="token keyword">then</span> <span class="token comment">--如果是夜晚给俩火炬</span>
		Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--设置玩家分数</span>
<span class="token keyword">function</span> <span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> addScore<span class="token punctuation">)</span>
	<span class="token keyword">if</span> playerId <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> currScore <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getGameScore</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span>
		<span class="token keyword">local</span> playScore <span class="token operator">=</span> currScore<span class="token operator">+</span>addScore
		<span class="token keyword">if</span> addScore <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token comment">--设置玩家分数</span>
			playScore <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> playScore<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
		Player<span class="token punctuation">:</span><span class="token function">setGameScore</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> playScore<span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> teamId <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getTeam</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> teamId<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">then</span>
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> teamScore <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamScore</span><span class="token punctuation">(</span>teamId<span class="token punctuation">)</span>
		<span class="token keyword">if</span> addScore <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token comment">--设置队伍分数</span>
			teamScore <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> addScore<span class="token operator">+</span>teamScore<span class="token punctuation">)</span>
			Team<span class="token punctuation">:</span><span class="token function">setTeamScore</span><span class="token punctuation">(</span>teamId<span class="token punctuation">,</span> teamScore<span class="token punctuation">)</span>
		<span class="token keyword">else</span>
			Team<span class="token punctuation">:</span><span class="token function">addTeamScore</span><span class="token punctuation">(</span>teamId<span class="token punctuation">,</span> addScore<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--重置tick次数</span>
<span class="token keyword">function</span> <span class="token function">IsCanTick</span><span class="token punctuation">(</span>isTick<span class="token punctuation">)</span>
	isTick <span class="token operator">=</span> isTick <span class="token keyword">or</span> <span class="token keyword">true</span>
	<span class="token keyword">if</span> isTick <span class="token keyword">then</span> Data<span class="token punctuation">.</span>tickCount <span class="token operator">=</span> Data<span class="token punctuation">.</span>tickCount<span class="token operator">+</span><span class="token number">1</span> <span class="token keyword">end</span>

	<span class="token keyword">if</span> Data<span class="token punctuation">.</span>tickCount<span class="token operator">&gt;=</span>Data<span class="token punctuation">.</span>newTicker <span class="token keyword">then</span>
		Data<span class="token punctuation">.</span>tickCount <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token keyword">return</span> <span class="token keyword">true</span>
	<span class="token keyword">end</span>

	<span class="token keyword">return</span> <span class="token keyword">false</span>
<span class="token keyword">end</span>

<span class="token comment">-------------------------------游戏事件-------------------------------</span>
Game_EnterRoom <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">-- 玩法地图不会调该方法,测试需开房间</span>
	<span class="token function">InitGameRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--初始化相关游戏规则</span>

	<span class="token comment">--重置游戏数据</span>
	Data<span class="token punctuation">.</span>tickCount <span class="token operator">=</span> <span class="token number">0</span>
	Data<span class="token punctuation">.</span>isGameEnd <span class="token operator">=</span> <span class="token keyword">false</span>
	Mobs<span class="token punctuation">.</span>gensCnt <span class="token operator">=</span> <span class="token number">0</span>
	Mobs<span class="token punctuation">.</span>deadCnt <span class="token operator">=</span> <span class="token number">0</span>

	<span class="token keyword">local</span> renderType <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">--小地图显示模式 1:旋转视角 2:全图俯视</span>
	<span class="token keyword">local</span> result <span class="token operator">=</span> UI<span class="token punctuation">:</span><span class="token function">setMinimapRenderMode</span><span class="token punctuation">(</span>renderType<span class="token punctuation">)</span>

	<span class="token comment">-- 设置一个标志位</span>
	<span class="token keyword">local</span> result <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">setScriptVar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span>
		result <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">sendScriptVars2Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

Game_StartGame <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> Data<span class="token punctuation">.</span>isRuleInit <span class="token keyword">then</span> <span class="token function">InitGameRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token function">InitCenterPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">--初始化地图中心点</span>
	<span class="token keyword">local</span> isTestMode <span class="token operator">=</span> <span class="token keyword">false</span> <span class="token comment">--测试模式</span>
	<span class="token function">InitGameMap</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token punctuation">,</span> isTestMode<span class="token punctuation">)</span>
	<span class="token function">InitGameMobs</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token punctuation">)</span>  <span class="token comment">--初始化游戏怪物</span>
	<span class="token function">InitGameItems</span><span class="token punctuation">(</span>Cfg<span class="token punctuation">.</span>map_size<span class="token punctuation">)</span> <span class="token comment">--初始化游戏道具</span>

	<span class="token function">InitGamePlayer</span><span class="token punctuation">(</span>isTestMode<span class="token punctuation">)</span> <span class="token comment">--初始化玩家信息</span>

	<span class="token keyword">local</span> x1<span class="token punctuation">,</span> x2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>Data<span class="token punctuation">.</span>markRadius<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>Data<span class="token punctuation">.</span>markRadius
	<span class="token keyword">local</span> z1<span class="token punctuation">,</span> z2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>Data<span class="token punctuation">.</span>markRadius<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>Data<span class="token punctuation">.</span>markRadius
	<span class="token function">drawMiniMark</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">,</span> x1<span class="token punctuation">,</span>x2<span class="token punctuation">,</span>z1<span class="token punctuation">,</span>z2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">--绘制小地图</span>
	<span class="token comment">--drawMiniMark(true, Pos.ix,Pos.iz,0,0, Data.markRadius,3)</span>

	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> text <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">3068</span><span class="token punctuation">)</span>
	Chat<span class="token punctuation">:</span><span class="token function">sendChat</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> Sys<span class="token punctuation">.</span>chatType<span class="token punctuation">)</span>
<span class="token keyword">end</span>

Game_Update <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> Data<span class="token punctuation">.</span>isGameEnd <span class="token keyword">or</span> Data<span class="token punctuation">.</span>isTimeout <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>
	<span class="token keyword">if</span> <span class="token function">IsCanTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token keyword">false</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	Data<span class="token punctuation">.</span>markRadius <span class="token operator">=</span> Data<span class="token punctuation">.</span>markRadius<span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">if</span> Data<span class="token punctuation">.</span>miniMarkId <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token comment">--标记还存在</span>
		<span class="token keyword">if</span> Data<span class="token punctuation">.</span>markRadius <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token comment">--刷新小地图标记</span>
			<span class="token keyword">local</span> x1<span class="token punctuation">,</span> x2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">-</span>Data<span class="token punctuation">.</span>markRadius<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>ix<span class="token operator">+</span>Data<span class="token punctuation">.</span>markRadius
			<span class="token keyword">local</span> z1<span class="token punctuation">,</span> z2 <span class="token operator">=</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">-</span>Data<span class="token punctuation">.</span>markRadius<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>iz<span class="token operator">+</span>Data<span class="token punctuation">.</span>markRadius
			<span class="token function">drawMiniMark</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">,</span> x1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token comment">--drawMiniMark(false, Pos.ix,Pos.iz,0,0, Data.markRadius,3)</span>
		<span class="token keyword">elseif</span> Data<span class="token punctuation">.</span>markRadius <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">then</span>
			MapMark<span class="token punctuation">:</span><span class="token function">showShape</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">,</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
			MapMark<span class="token punctuation">:</span><span class="token function">deleteShape</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>miniMarkId<span class="token punctuation">)</span>
			Data<span class="token punctuation">.</span>miniMarkId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
	<span class="token comment">--[==[
	if Data.glEffectId &gt;= 0 then --进入小圈后去掉全部debuff
		local ret, playerId = Player:getMainPlayerUin()
		if ret==ErrorCode.OK and playerId&gt;0 then
			local ret, x,y,z = Player:getPosition(playerId)
			if ret == ErrorCode.OK then
				if (x-Pos.cx)*(x-Pos.cx)+(z-Pos.cz)*(z-Pos.cz) &lt; Pos.cr*Pos.cr then
					Player:clearAllBadBuff(playerId)--去掉debuff
					local ret, buffN, buffLt = Player:getBuffList(playerId)
					if ret==ErrorCode.OK and buffNum&gt;=3 then

					end
				end
			end
			--[[
			local ret, actorHp = Actor:getHP(playerId)
			if ret==ErrorCode.OK and actorHp&lt;=15 then
				local ret = Actor:tryMoveToPos(playerId, Pos.cx, Pos.iy+1, Pos.cz, 5.0)
				print(&quot;Move=============&gt;&gt;&gt;&quot;, ret)
			end
			--]]
		end
	end
	--]==]</span>

	<span class="token comment">--/1、怪物已经全被干掉</span>
	<span class="token keyword">if</span> Mobs<span class="token punctuation">.</span>gensCnt<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">and</span> Mobs<span class="token punctuation">.</span>deadCnt<span class="token operator">&gt;=</span>Mobs<span class="token punctuation">.</span>gensCnt <span class="token keyword">then</span>
		Data<span class="token punctuation">.</span>isGameEnd <span class="token operator">=</span> <span class="token keyword">true</span>
		Game<span class="token punctuation">:</span><span class="token function">doGameEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token keyword">end</span>

	<span class="token comment">--/2、分数达到某值则结束游戏/GameRule设置有问题</span>
	<span class="token keyword">if</span> Cfg<span class="token punctuation">.</span>max_score <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
		<span class="token keyword">for</span> teamId <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span><span class="token punctuation">{</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> Teams<span class="token punctuation">.</span>blue<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
			<span class="token keyword">local</span> ret<span class="token punctuation">,</span> score <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamScore</span><span class="token punctuation">(</span>teamId<span class="token punctuation">)</span>
			<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> score<span class="token operator">&gt;=</span>Cfg<span class="token punctuation">.</span>max_score <span class="token keyword">then</span>
				Data<span class="token punctuation">.</span>isGameEnd <span class="token operator">=</span> <span class="token keyword">true</span>
				Game<span class="token punctuation">:</span><span class="token function">doGameEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token keyword">end</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token comment">-- 单人模式下不计算存活规则</span>
	<span class="token keyword">local</span> ret1<span class="token punctuation">,</span> btNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamPlayers</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret1<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">or</span> btNum<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>
	<span class="token keyword">local</span> ret2<span class="token punctuation">,</span> rtNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamPlayers</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret2<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">or</span> rtNum<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token comment">--/3、玩家无存活则游戏结束</span>
	<span class="token keyword">local</span> ret1<span class="token punctuation">,</span> raNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamPlayers</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> LiveType<span class="token punctuation">.</span>alive<span class="token punctuation">)</span>
	<span class="token keyword">local</span> ret2<span class="token punctuation">,</span> baNum <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamPlayers</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">,</span> LiveType<span class="token punctuation">.</span>alive<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret1 <span class="token operator">~=</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">or</span> ret2 <span class="token operator">~=</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token keyword">if</span> raNum<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">and</span> baNum<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span>
		Data<span class="token punctuation">.</span>isGameEnd <span class="token operator">=</span> <span class="token keyword">true</span>
		Game<span class="token punctuation">:</span><span class="token function">doGameEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

Game_GameEnd <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;GameEnd1 ================&gt;&gt;&gt;Func&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">local</span> ret1<span class="token punctuation">,</span> rxScore <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamScore</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">)</span>
	<span class="token keyword">local</span> ret2<span class="token punctuation">,</span> bxScore <span class="token operator">=</span> Team<span class="token punctuation">:</span><span class="token function">getTeamScore</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">)</span>

	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;GameEnd2 ================&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> ret1<span class="token punctuation">,</span> ret2<span class="token punctuation">,</span> rxScore<span class="token punctuation">,</span> bxScore<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret1<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>FAILED <span class="token keyword">or</span> ret2<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>FAILED <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> result <span class="token operator">=</span> rxScore <span class="token operator">&gt;=</span> bxScore
	<span class="token keyword">local</span> isClient <span class="token operator">=</span> <span class="token keyword">true</span> <span class="token comment">--主客机标志</span>

	<span class="token keyword">if</span> result <span class="token keyword">then</span> <span class="token comment">--红队/主队胜利</span>
		<span class="token function">Battle_Ended</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>red<span class="token punctuation">,</span> Battle<span class="token punctuation">.</span>win<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token keyword">not</span> isClient <span class="token keyword">then</span> <span class="token comment">--主队胜利提示</span>
			<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtInfox <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">270</span><span class="token punctuation">)</span>
			Chat<span class="token punctuation">:</span><span class="token function">sendChat</span><span class="token punctuation">(</span>txtInfox<span class="token punctuation">,</span>  Sys<span class="token punctuation">.</span>chatType<span class="token punctuation">)</span>
		<span class="token keyword">else</span> <span class="token comment">--客队失败提示</span>
			<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtInfox <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">271</span><span class="token punctuation">)</span>
			Chat<span class="token punctuation">:</span><span class="token function">sendChat</span><span class="token punctuation">(</span>txtInfox<span class="token punctuation">,</span>  Sys<span class="token punctuation">.</span>chatType<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">else</span>
		<span class="token function">Battle_Ended</span><span class="token punctuation">(</span>Teams<span class="token punctuation">.</span>blue<span class="token punctuation">,</span> Battle<span class="token punctuation">.</span>win<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token keyword">not</span> isClient <span class="token keyword">then</span> <span class="token comment">--主队失败提示</span>
			<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtInfox <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">271</span><span class="token punctuation">)</span>
			Chat<span class="token punctuation">:</span><span class="token function">sendChat</span><span class="token punctuation">(</span>txtInfox<span class="token punctuation">,</span>  Sys<span class="token punctuation">.</span>chatType<span class="token punctuation">)</span>
		<span class="token keyword">else</span> <span class="token comment">--客队胜利提示</span>
			<span class="token keyword">local</span> ret<span class="token punctuation">,</span> txtInfox <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getDefString</span><span class="token punctuation">(</span><span class="token number">270</span><span class="token punctuation">)</span>
			Chat<span class="token punctuation">:</span><span class="token function">sendChat</span><span class="token punctuation">(</span>txtInfox<span class="token punctuation">,</span>  Sys<span class="token punctuation">.</span>chatType<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

Game_TimeOver <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">--超时比得分,高分获胜</span>
	Data<span class="token punctuation">.</span>isTimeout <span class="token operator">=</span> <span class="token keyword">true</span>
<span class="token keyword">end</span>

<span class="token comment">-------------------------------玩家事件-------------------------------</span>
Player_Inited <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> playerId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token keyword">not</span> Data<span class="token punctuation">.</span>isRuleInit <span class="token keyword">then</span> <span class="token function">InitGameRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">end</span>

	<span class="token comment">-- 进入房间开始游戏前时调用</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> val <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">getScriptVar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 干掉对方玩家可+5分/已在GameRule里设置</span>
Player_Dead <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> playerId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> killedBy <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'toobjid'</span><span class="token punctuation">]</span>

	<span class="token keyword">if</span> playerId <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">--死亡-5分</span>
<span class="token keyword">end</span>

Player_Revive <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> playerId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>

	<span class="token comment">--复活保护BUFF&lt;BuffId要除1000&gt;/GameRule可设置</span>
	<span class="token keyword">local</span> buffId <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">999002</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span>
	Player<span class="token punctuation">:</span><span class="token function">addBuff</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> buffId<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>

	<span class="token keyword">local</span> buffId1 <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token number">27003</span><span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span>
	Player<span class="token punctuation">:</span><span class="token function">addBuff</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> buffId1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">500000</span><span class="token punctuation">)</span>

	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> teamId <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getTeam</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">~=</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">or</span> teamId<span class="token operator">&lt;=</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>
	<span class="token function">ResetPosition</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> teamId<span class="token punctuation">)</span> <span class="token comment">--回到复活点复活</span>

	<span class="token comment">--设置饱食度/防止血量自增</span>
	Player<span class="token punctuation">:</span><span class="token function">setFoodLevel</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span>

	<span class="token comment">-- 默认给玩家一把短刀(ItemId:12003)防御</span>
	<span class="token keyword">local</span> itemId<span class="token punctuation">,</span> itemCnt <span class="token operator">=</span> <span class="token number">12003</span><span class="token punctuation">,</span> <span class="token number">1</span>
	<span class="token keyword">local</span> ret <span class="token operator">=</span> Backpack<span class="token punctuation">:</span><span class="token function">enoughSpaceForItem</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Player<span class="token punctuation">:</span><span class="token function">gainItems</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemId<span class="token punctuation">,</span> itemCnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">end</span>
<span class="token keyword">end</span>

Player_JoinTeam <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> playerId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>

    <span class="token comment">-- 流程有问题，暂时无法设置多人组,默认1人组</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> teamId <span class="token operator">=</span> Player<span class="token punctuation">:</span><span class="token function">getTeam</span><span class="token punctuation">(</span>playerId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> teamId<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">then</span>
		<span class="token function">ResetPosition</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> teamId<span class="token punctuation">)</span> <span class="token comment">--设置队伍位置</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">local</span> itemCount <span class="token operator">=</span> <span class="token number">0</span>
Player_AddItem <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> itemId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'itemid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> itemNum <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'itemnum'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> playerId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>

	<span class="token keyword">if</span> itemId<span class="token operator">==</span>Items<span class="token punctuation">.</span>rewardIdx <span class="token keyword">and</span> playerId<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">then</span>
		<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> itemNum<span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>

	<span class="token keyword">if</span> itemId <span class="token operator">==</span> Items<span class="token punctuation">.</span>rewardIdx <span class="token keyword">then</span>
		<span class="token keyword">local</span> result<span class="token punctuation">,</span> state <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">getCameraEditState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'当前视角编辑状态：'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">end</span>
		<span class="token comment">--[[
		state = CameraEditState.CAMERA_EDIT_STATE_EDIT
		local result = World:setCameraEditState(state)
		print('已成功设置视角编辑状态？', result==ErrorCode.OK and '成功' or '失败')
		--]]</span>
		<span class="token keyword">local</span> result<span class="token punctuation">,</span> config <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">getCustomCameraConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> config<span class="token operator">~=</span><span class="token keyword">nil</span> <span class="token keyword">then</span> <span class="token comment">--自定义视角</span>
			config<span class="token punctuation">:</span><span class="token function">setOption</span><span class="token punctuation">(</span>CAMERA_OPTION_INDEX_CONFIG_SET<span class="token punctuation">,</span> CCG_FLATVIEW<span class="token punctuation">)</span>
		<span class="token keyword">end</span>

		<span class="token keyword">local</span> actorType <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--OBJ_TYPE_MONSTER</span>
		<span class="token keyword">local</span> x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> z1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5</span>
		<span class="token keyword">local</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> z2 <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">15</span>
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> num<span class="token punctuation">,</span> array <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">getActorsByBox</span><span class="token punctuation">(</span>actorType<span class="token punctuation">,</span> x1<span class="token punctuation">,</span>y1<span class="token punctuation">,</span>z1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span>y2<span class="token punctuation">,</span>z2<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret <span class="token operator">==</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Creature ===&gt;&gt; '</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token keyword">end</span>

		<span class="token keyword">local</span> aliveType <span class="token operator">=</span> LiveType<span class="token punctuation">.</span>all
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> num<span class="token punctuation">,</span> array <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">getAllPlayers</span><span class="token punctuation">(</span>aliveType<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret <span class="token operator">==</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Actors ===&gt;&gt; '</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token keyword">end</span>

		<span class="token keyword">local</span> aliveType <span class="token operator">=</span> LiveType<span class="token punctuation">.</span>alive
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> playerId <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">randomOnePlayer</span><span class="token punctuation">(</span>aliveType<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret <span class="token operator">==</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Player ===&gt;&gt; '</span><span class="token punctuation">,</span> playerId<span class="token punctuation">)</span> <span class="token keyword">end</span>

		<span class="token keyword">local</span> result <span class="token operator">=</span> World<span class="token punctuation">:</span><span class="token function">despawnActor</span><span class="token punctuation">(</span>Mobs<span class="token punctuation">.</span>objIds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> result <span class="token operator">==</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Despawn Actorx ===&gt;&gt; '</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token keyword">end</span>
	<span class="token keyword">end</span>

	<span class="token comment">-- local modx = math.mod(itemCount, 3)</span>
	<span class="token comment">-- if modx==0 then CheckBackpackAPI('SC', itemId) end</span>
	<span class="token comment">-- if modx==1 then CheckBackpackAPI('BC', itemId) end</span>
	<span class="token comment">-- if modx==2 then CheckBackpackAPI('EC', itemId) end</span>
	itemCount <span class="token operator">=</span> itemCount <span class="token operator">+</span> <span class="token number">1</span>
<span class="token keyword">end</span>

<span class="token comment">-------------------------------怪物事件-------------------------------</span>
<span class="token comment">-- 伤害源为玩家或怪物</span>
Actor_Die <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Monster_Dead==========&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> mobId<span class="token punctuation">,</span> actorId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'toobjid'</span><span class="token punctuation">]</span>

	<span class="token keyword">local</span> addScore <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">--额外加分情况</span>
	<span class="token keyword">local</span> ret<span class="token punctuation">,</span> defId <span class="token operator">=</span> Creature<span class="token punctuation">:</span><span class="token function">getActorID</span><span class="token punctuation">(</span>mobId<span class="token punctuation">)</span>

	<span class="token keyword">if</span> defId<span class="token operator">==</span>Items<span class="token punctuation">.</span>mobsIdx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span> <span class="token comment">--弓手</span>
		addScore <span class="token operator">=</span> <span class="token number">2</span>
		Mobs<span class="token punctuation">.</span>deadCnt <span class="token operator">=</span> Mobs<span class="token punctuation">.</span>deadCnt<span class="token operator">+</span><span class="token number">1</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'FFc=======&gt;&gt;&gt;'</span><span class="token punctuation">,</span> Mobs<span class="token punctuation">.</span>deadCnt<span class="token punctuation">)</span>
	<span class="token keyword">elseif</span> defId<span class="token operator">==</span>Items<span class="token punctuation">.</span>fishIdx <span class="token keyword">then</span> <span class="token comment">--灯笼鱼</span>
		addScore <span class="token operator">=</span> <span class="token number">5</span>
	<span class="token keyword">end</span>

	<span class="token keyword">if</span> addScore<span class="token operator">==</span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>

	<span class="token keyword">local</span> result <span class="token operator">=</span> Actor<span class="token punctuation">:</span><span class="token function">isPlayer</span><span class="token punctuation">(</span>actorId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span><span class="token comment">--怪物被玩家干掉</span>
		<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>actorId<span class="token punctuation">,</span> addScore<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token keyword">end</span>

	<span class="token comment">--被玩家驯服的动物干掉</span>
	<span class="token keyword">local</span> result <span class="token operator">=</span> Actor<span class="token punctuation">:</span><span class="token function">isMob</span><span class="token punctuation">(</span>actorId<span class="token punctuation">)</span>
	<span class="token keyword">if</span> result<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span>
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> playerId <span class="token operator">=</span> Creature<span class="token punctuation">:</span><span class="token function">getTamedOwnerID</span><span class="token punctuation">(</span>actorId<span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> playerId<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">then</span>
			<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>playerId<span class="token punctuation">,</span> addScore<span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-------------------------------方块事件-------------------------------</span>
<span class="token comment">--生成战旗后添加雾圈效果</span>
Block_Added <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Block_Added==========&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'blockid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span>

	<span class="token keyword">if</span> blockId<span class="token operator">==</span><span class="token number">919</span> <span class="token keyword">or</span> blockId<span class="token operator">==</span><span class="token number">920</span> <span class="token keyword">then</span>
		<span class="token keyword">if</span> Data<span class="token punctuation">.</span>glEffectId <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token keyword">return</span> <span class="token keyword">end</span>
		<span class="token keyword">local</span> ret<span class="token punctuation">,</span> glEffectId <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">addRenderGlobalEffect</span><span class="token punctuation">(</span><span class="token string">&quot;particles/Fog.ent&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> ret<span class="token operator">==</span>ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">and</span> glEffectId <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">then</span>
			Data<span class="token punctuation">.</span>glEffectId <span class="token operator">=</span> glEffectId
			Game<span class="token punctuation">:</span><span class="token function">setRenderGlobalEffectPos</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>glEffectId<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>cx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>cz<span class="token punctuation">)</span>
			Game<span class="token punctuation">:</span><span class="token function">setRenderGlobalEffectScale</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>glEffectId<span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>cr<span class="token operator">/</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">0.045</span><span class="token punctuation">,</span> Pos<span class="token punctuation">.</span>cr<span class="token operator">/</span><span class="token number">4.0</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--战旗被摧毁后雾圈消失/治疗效果消失</span>
Block_Removed <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Block_removed===========&gt;&gt;&gt;'</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'blockid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span>

	<span class="token keyword">if</span> Data<span class="token punctuation">.</span>glEffectId <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token comment">--删除雾圈效果</span>
		 <span class="token keyword">local</span> ret <span class="token operator">=</span> Game<span class="token punctuation">:</span><span class="token function">removeRenderGlobalEffect</span><span class="token punctuation">(</span>Data<span class="token punctuation">.</span>glEffectId<span class="token punctuation">)</span>
		 <span class="token keyword">if</span> ret <span class="token operator">==</span> ErrorCode<span class="token punctuation">.</span>OK <span class="token keyword">then</span> Data<span class="token punctuation">.</span>glEffectId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--将南瓜灯放置到对应的队旗旁+12fen</span>
Block_PlacedBy <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Block_placed===========&gt;&gt;&gt;'</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'blockid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token comment">--获取宝箱并将其打掉的队伍可+7分</span>
Block_DestroyBy <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Block_DestroyBy===========&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'blockid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> actorId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span>

	<span class="token keyword">if</span> actorId <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
		<span class="token keyword">if</span> blockId <span class="token operator">==</span> posBlocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span><span class="token comment">--罐子</span>
			<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>actorId<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
		<span class="token keyword">elseif</span> blockId <span class="token operator">==</span> posBlocks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">then</span><span class="token comment">--南瓜灯</span>
			<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>actorId<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span>
		<span class="token keyword">end</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">--点燃台灯+10分/点燃烟花+20分</span>
Block_TriggerBy <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Block_trigger===========&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'blockid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> actorId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span>

	<span class="token keyword">if</span> blockId<span class="token operator">==</span>itemLamps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">then</span><span class="token comment">--烟花</span>
		<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>actorId<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
	<span class="token keyword">elseif</span> blockId<span class="token operator">==</span>itemLamps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">or</span> blockId<span class="token operator">==</span>itemLamps<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
		<span class="token function">PlayerAddScore</span><span class="token punctuation">(</span>actorId<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment">--[==[
--碰撞区撞到方块会触发变身效果
Block_CollidedBy = function(trigger_obj)
	print(&quot;Block_Collided===========&gt;&gt;&gt;&quot;, trigger_obj)
	local blockId = trigger_obj['blockid']
	local actorId = trigger_obj['eventobjid']
	local x, y, z = trigger_obj['x'], trigger_obj['y'], trigger_obj['z']

	local result = Actor:isPlayer(actorId)
	if result ~= ErrorCode.OK then return end --非玩家触发

	local buffId, buffLv = 0, 1
	if blockId == negBlocks[1] then--变鸡Buff
		buffId = math.floor(1003001/1000)
	elseif blockId == negBlocks[2] then--变羊Buff
		buffId = math.floor(1005001/1000)
	end
	if buffId == 0 then return end

	local ret = Player:hasBuff(actorId, buffId)
	if ret == ErrorCode.OK then --设置buff时长/60秒
		local ret, ticks = Player:getBuffLeftTick(actorId, buffId)
		print('TT===========&gt;&gt;&gt;', ret, ticks)
		if ret==ErrorCode.OK and ticks&lt;=60*20 then
			Player:addBuff(actorId, buffId, buffLv, 60*20)
		end
	else
		Player:addBuff(actorId, buffId, buffLv, 60*20)
	end
end

--加血区每秒加1生命值
Block_WalkedBy = function(trigger_obj)
	print(&quot;Block_walking===========&gt;&gt;&gt;&quot;, trigger_obj)
	local blockId = trigger_obj['blockid']
	local actorId = trigger_obj['eventobjid']
	local x, y, z = trigger_obj['x'], trigger_obj['y'], trigger_obj['z']
	if Data.glEffectId == -1 then return end

	local result = Actor:isPlayer(actorId)
	if result ~= ErrorCode.OK then return end --非玩家触发

	if blockId == Items.treatId then
		local ret1, maxHp = Player:getMaxHP(actorId)
		if ret1 ~= ErrorCode.OK then return end
		local ret2, curHp = Player:getHP(actorId)
		if ret2 ~= ErrorCode.OK then return end

		if curHp &lt; maxHp then --加血
			local ret = Player:addHP(actorId, 1)
		end
	end
end
--]==]</span>
Block_FertilizedBy <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>trigger_obj<span class="token punctuation">)</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Block_fertilized===========&gt;&gt;&gt;&quot;</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">)</span>
	<span class="token keyword">local</span> blockId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'blockid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> actorId <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'eventobjid'</span><span class="token punctuation">]</span>
	<span class="token keyword">local</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> trigger_obj<span class="token punctuation">[</span><span class="token string">'z'</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>

<span class="token function">ListenEvents_MiniDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Lua/void.html" class="prev">
        不那么仁慈的虚空
      </a></span> <span class="next"><a href="/Lua/tankx.html">
        坦克对战
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ef735673.js" defer></script><script src="/assets/js/2.b51029ec.js" defer></script><script src="/assets/js/46.b5d5ec9d.js" defer></script>
  </body>
</html>
